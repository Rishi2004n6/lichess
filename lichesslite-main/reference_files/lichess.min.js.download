var hi=Object.defineProperty;var po=(e,t)=>{for(var o in t)hi(e,o,{get:t[o],enumerable:!0})};var d={date:"2023-10-22T05:39:48+00:00",commit:"5f931266df947c4aeb62269a7a458367b2cc8037",message:"Merge pull request #13809 from schlawg/lobby-leaderboard-hide-ratings"};var He="\uE025";var fo="\uE038";var ho="\uE03A";var mo="\uE048";var go="\uE04D";var vo="\uE056";var bo="\uE05A";var wo="\uE065";var Ve={};po(Ve,{fenColor:()=>ze,init:()=>So,initAll:()=>Ue,initWith:()=>Ao,renderClock:()=>vi});function ft(e,t,o,n,i){let r=t===void 0?void 0:t.key;return{sel:e,data:t,children:o,text:n,elm:i,key:r}}var ht=Array.isArray;function Ne(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function yo(e,t,o){if(e.ns="http://www.w3.org/2000/svg",o!=="foreignObject"&&t!==void 0)for(let n=0;n<t.length;++n){let i=t[n];if(typeof i=="string")continue;let r=i.data;r!==void 0&&yo(r,i.children,i.sel)}}function mt(e,t,o){let n={},i,r,s;if(o!==void 0?(t!==null&&(n=t),ht(o)?i=o:Ne(o)?r=o.toString():o&&o.sel&&(i=[o])):t!=null&&(ht(t)?i=t:Ne(t)?r=t.toString():t&&t.sel?i=[t]:n=t),i!==void 0)for(s=0;s<i.length;++s)Ne(i[s])&&(i[s]=ft(void 0,void 0,void 0,i[s],void 0));return e[0]==="s"&&e[1]==="v"&&e[2]==="g"&&(e.length===3||e[3]==="."||e[3]==="#")&&yo(n,i,e),ft(e,n,i,r,void 0)}var xo=e=>`lichess-${e}`,Re=(e,t)=>e[xo(t)],se=(e,t,o)=>e[xo(t)]=o;var ko=["white","black"],ae=["a","b","c","d","e","f","g","h"],he=["1","2","3","4","5","6","7","8"];var Po=[...he].reverse(),qe=Array.prototype.concat(...ae.map(e=>he.map(t=>e+t))),P=e=>qe[8*e[0]+e[1]],m=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],me=e=>{if(e)return e[1]==="@"?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},Be=qe.map(m);function Co(e){let t,o=()=>(t===void 0&&(t=e()),t);return o.clear=()=>{t=void 0},o}var Mo=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},ge=e=>e==="white"?"black":"white",G=(e,t)=>{let o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},ve=(e,t)=>e.role===t.role&&e.color===t.color,X=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],A=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},vt=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},be=(e,t)=>{e.style.visibility=t?"visible":"hidden"},W=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},We=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},E=(e,t)=>{let o=document.createElement(e);return t&&(o.className=t),o};function Ke(e,t,o){let n=m(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}var So=e=>{let[t,o,n]=e.getAttribute("data-state").split(",");Ao(e,t,o,n)},Ao=(e,t,o,n)=>{se(e,"chessground",lichess.makeChessground(e,{orientation:o,coordinates:!1,viewOnly:!e.getAttribute("data-playable"),fen:t,lastMove:me(n),drawable:{enabled:!1,visible:!1}}))},Ue=e=>Array.from((e||document).getElementsByClassName("mini-board--init")).forEach(t=>{t.classList.remove("mini-board--init"),So(t)}),ze=e=>e.includes(" w")?"white":"black",vi=(e,t)=>mt(`span.mini-game__clock.mini-game__clock--${e}`,{attrs:{"data-time":t,"data-managed":1}});var Ge={};po(Ge,{finish:()=>Tt,init:()=>No,initAll:()=>je,update:()=>kt});function we(e,t){let o=Re(e,"clock");o?o.set(t):se(e,"clock",new wt(e,t))}var wt=class{constructor(t,o){this.el=t;this.opts=o;this.set=t=>{this.opts=t,this.target=t.time*1e3+Date.now(),this.render(),clearInterval(this.interval),t.pause||(this.interval=setInterval(this.render,1e3))};this.render=()=>{document.body.contains(this.el)?(this.el.textContent=bi(this.target-Date.now()),this.el.classList.toggle("clock--run",!this.opts.pause)):clearInterval(this.interval)};this.target=o.time*1e3+Date.now(),o.pause||(this.interval=setInterval(this.render,1e3)),this.render()}},bi=e=>{let t=new Date(Math.max(0,e+500)),o=t.getUTCHours(),n=t.getUTCMinutes(),i=t.getUTCSeconds();return o>0?o+":"+bt(n)+":"+bt(i):n+":"+bt(i)},bt=e=>(e<10?"0":"")+e;var le=e=>e!==void 0,ye=e=>e!=null;var xe=e=>{let t;return()=>(t===void 0&&(t=e()),t)};var wi={cache:"no-cache",credentials:"same-origin"},yi={"X-Requested-With":"XMLHttpRequest"},xi=e=>{if(e.ok)return e;throw e.status==429?new Error("Too many requests"):e.status==413?new Error("The uploaded file is too large"):new Error(`Error ${e.status}`)};var D=(e,t={})=>ki(e,t).then(o=>xi(o).text()),ki=(e,t={})=>fetch(e,{...wi,headers:{...yi},...t}),Eo=e=>new Promise((t,o)=>{let n=document.body.getAttribute("data-nonce"),i=document.createElement("script");n&&i.setAttribute("nonce",n),i.onload=t,i.onerror=o,i.src=e,document.head.append(i)}),Fe=e=>{let t=new FormData;for(let o of Object.keys(e))le(e[o])&&t.append(o,e[o]);return t},$o=(e,t)=>{let o=new URLSearchParams;for(let i of Object.keys(t))le(t[i])&&o.append(i,t[i]);let n=o.toString();return n?`${e}?${n}`:e},Lo=(e,t)=>{let o=e.getAttribute("action"),n=new FormData(e);return t!=null&&t.name&&(t!=null&&t.value)&&n.set(t.name,t.value),o?D(o,{method:e.method,body:n}):Promise.reject(`Form has no action: ${e}`)};function ke(e,t,o){let n=["mousemove","touchstart"],i=!1,r=!0,s=performance.now(),a=()=>{r||o(),r=!0,s=performance.now(),c()},l=()=>{i||(n.forEach(u=>document.addEventListener(u,a)),i=!0)},c=()=>{i&&(n.forEach(u=>document.removeEventListener(u,a)),i=!1)};setInterval(()=>{r&&performance.now()-s>e&&(t(),r=!1),l()},1e4)}var _o=()=>{try{let e=window.crypto.getRandomValues(new Uint8Array(9));return btoa(String.fromCharCode(...e)).replace(/[/+]/g,"_")}catch(e){return Math.random().toString(36).slice(2,12)}};var Ti=_o(),Z=Ti;var Do=!1,Io=async(e,t)=>{try{t&&await lichess.sound.play("genericNotify")}catch(i){console.warn(i)}let o;if(typeof e=="string")o=e;else if(o=e.url,e.cookie){let i=[encodeURIComponent(e.cookie.name)+"="+e.cookie.value,"; max-age="+e.cookie.maxAge,"; path=/","; domain="+location.hostname].join("");document.cookie=i}let n="//"+location.host+"/"+o.replace(/^\//,"");Do=n,location.href=n},yt={expected:!1},ee=()=>{Do||(yt.expected=!0,lichess.socket.disconnect(),location.hash?location.reload():location.assign(location.href))};var Oo=e=>{let t={get:o=>e.getItem(o),set:(o,n)=>e.setItem(o,n),fire:(o,n)=>e.setItem(o,JSON.stringify({sri:Z,nonce:Math.random(),value:n})),remove:o=>e.removeItem(o),make:o=>({get:()=>t.get(o),set:n=>t.set(o,n),fire:n=>t.fire(o,n),remove:()=>t.remove(o),listen:n=>window.addEventListener("storage",i=>{if(i.key!==o||i.storageArea!==e||i.newValue===null)return;let r;try{r=JSON.parse(i.newValue)}catch(s){return}r!=null&&r.sri&&r.sri!==Z&&n(r)})}),boolean:o=>({get:()=>t.get(o)=="1",getOrDefault:n=>{let i=t.get(o);return i===null?n:i=="1"},set:n=>t.set(o,n?"1":"0"),toggle:()=>t.set(o,t.get(o)=="1"?"0":"1")})};return t},L=Oo(window.localStorage),Ho=Oo(window.sessionStorage);function Te(e,t){return t==="always"?!0:L.get(e)?!1:(L.set(e,"1"),!0)}var Pi=WebSocket.prototype.send,K=class K{constructor(t,o,n={}){this.url=t;this.pubsub=lichess.pubsub;this.ackable=new xt((t,o,n)=>this.send(t,o,n));this.lastPingTime=performance.now();this.pongCount=0;this.averageLag=0;this.tryOtherUrl=!1;this.autoReconnect=!0;this.nbConnects=0;this.storage=L.make("surl17");this.resendWhenOpen=[];this.sign=t=>{this._sign=t,this.ackable.sign(t)};this.connect=()=>{this.destroy(),this.autoReconnect=!0;let t=$o(this.options.protocol+"//"+this.baseUrl()+this.url,{...this.settings.params,v:this.version===!1?void 0:this.version});this.debug("connection attempt to "+t);try{let o=this.ws=new WebSocket(t);o.onerror=n=>this.onError(n),o.onclose=()=>{this.pubsub.emit("socket.close"),this.autoReconnect&&(this.debug("Will autoreconnect in "+this.options.autoReconnectDelay),this.scheduleConnect(this.options.autoReconnectDelay))},o.onopen=()=>{this.debug("connected to "+t),this.onSuccess();let n=document.body.classList;n.remove("offline"),n.add("online"),n.toggle("reconnected",this.nbConnects>1),this.pingNow(),this.resendWhenOpen.forEach(([i,r,s])=>this.send(i,r,s)),this.resendWhenOpen=[],this.pubsub.emit("socket.open"),this.ackable.resend()},o.onmessage=n=>{if(n.data==0)return this.pong();let i=JSON.parse(n.data);i.t==="n"&&this.pong(),this.handle(i)}}catch(o){this.onError(o)}this.scheduleConnect(this.options.pingMaxLag)};this.send=(t,o,n={},i=!1)=>{let r={t};o!==void 0&&(n.withLag&&(o.l=Math.round(this.averageLag)),n.millis>=0&&(o.s=Math.round(n.millis*.1).toString(36)),r.d=o),n.ackable&&(r.d=r.d||{},this.ackable.register(t,r.d));let s=JSON.stringify(r);if(!(t=="racerScore"&&n.sign!=this._sign)){if(t=="move"&&n.sign!=this._sign){let a;try{a=new Error().stack.split(`
`).join(" / ").replace(/\s+/g," ")}catch(l){a=`${l.message} ${navigator.userAgent}`}a.includes("round.nvui")||setTimeout(()=>{Te(`socket.rep.${Math.round(Date.now()/1e3/3600/3)}`)?this.send("rep",{n:`soc: ${s} ${a}`}):lichess.socket.destroy()},1e4)}this.debug("send "+s),!this.ws||this.ws.readyState===WebSocket.CONNECTING?i||this.resendWhenOpen.push([t,r.d,n]):Pi.apply(this.ws,[s])}};this.scheduleConnect=t=>{this.options.idle&&(t=10*1e3+Math.random()*10*1e3),clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.connectSchedule=setTimeout(()=>{document.body.classList.add("offline"),document.body.classList.remove("online"),this.tryOtherUrl=!0,this.connect()},t)};this.schedulePing=t=>{clearTimeout(this.pingSchedule),this.pingSchedule=setTimeout(this.pingNow,t)};this.pingNow=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule);let t=this.options.isAuth&&this.pongCount%10==2?JSON.stringify({t:"p",l:Math.round(.1*this.averageLag)}):"null";try{this.ws.send(t),this.lastPingTime=performance.now()}catch(o){this.debug(o,!0)}this.scheduleConnect(this.options.pingMaxLag)};this.computePingDelay=()=>this.options.pingDelay+(this.options.idle?1e3:0);this.pong=()=>{clearTimeout(this.connectSchedule),this.schedulePing(this.computePingDelay());let t=Math.min(performance.now()-this.lastPingTime,1e4);this.pongCount++;let o=this.pongCount>4?.1:1/this.pongCount;this.averageLag+=o*(t-this.averageLag),this.pubsub.emit("socket.lag",this.averageLag)};this.handle=t=>{if(t.v&&this.version!==!1){if(t.v<=this.version){this.debug("already has event "+t.v);return}if(t.v>this.version+1)return ee();this.version=t.v}switch(t.t||!1){case!1:break;case"resync":ee();break;case"ack":this.ackable.onServerAck(t.d);break;default:this.settings.receive&&this.settings.receive(t.t,t.d)||this.settings.events[t.t]&&this.settings.events[t.t](t.d||null,t)||this.pubsub.emit("socket.in."+t.t,t.d,t)}};this.debug=(t,o=!1)=>{(o||this.options.debug)&&console.debug(t)};this.destroy=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.disconnect(),this.ws=void 0};this.disconnect=()=>{let t=this.ws;t&&(this.debug("Disconnect"),this.autoReconnect=!1,t.onerror=t.onclose=t.onopen=t.onmessage=()=>{},t.close())};this.onError=t=>{this.options.debug=!0,this.debug(`error: ${t} ${JSON.stringify(t)}`),this.tryOtherUrl=!0,clearTimeout(this.pingSchedule)};this.onSuccess=()=>{if(this.nbConnects++,this.nbConnects==1){K.resolveFirstConnect(this.send);let t;ke(10*60*1e3,()=>{this.options.idle=!0,t=setTimeout(this.destroy,2*60*60*1e3)},()=>{this.options.idle=!1,this.ws?clearTimeout(t):location.reload()})}};this.baseUrl=()=>{let t=document.body.dataset.socketDomains.split(","),o=this.storage.get();return(!o||this.tryOtherUrl)&&(o=t[Math.floor(Math.random()*t.length)],this.storage.set(o)),o};this.pingInterval=()=>this.computePingDelay()+this.averageLag;this.getVersion=()=>this.version;this.settings={receive:n.receive,events:n.events||{},params:{...K.defaultParams,...n.params||{}}},this.options={...K.defaultOptions,...n.options||{}},this.version=o,this.pubsub.on("socket.send",this.send),this.connect()}};K.defaultOptions={idle:!1,pingMaxLag:9e3,pingDelay:2500,autoReconnectDelay:3500,protocol:location.protocol==="https:"?"wss:":"ws:",isAuth:document.body.hasAttribute("data-user")},K.defaultParams={sri:Z},K.firstConnect=new Promise(t=>{K.resolveFirstConnect=t});var U=K,xt=class{constructor(t){this.send=t;this.currentId=1;this.messages=[];this.sign=t=>this._sign=t;this.resend=()=>{let t=performance.now()-2500;this.messages.forEach(o=>{o.at<t&&this.send(o.t,o.d,{sign:this._sign})})};this.register=(t,o)=>{o.a=this.currentId++,this.messages.push({t,d:o,at:performance.now()})};this.onServerAck=t=>{this.messages=this.messages.filter(o=>o.d.a!==t)};setInterval(this.resend,1200)}};var No=(e,t)=>{let[o,n,i]=e.getAttribute("data-state").split(","),r={coordinates:!1,viewOnly:!0,fen:o,orientation:n,lastMove:me(i),drawable:{enabled:!1,visible:!1}},s=$(e).removeClass("mini-game--init"),a=s.find(".cg-wrap"),l=ze(o);return se(a[0],"chessground",(t!=null?t:lichess.makeChessground)(a[0],r)),["white","black"].forEach(c=>s.find(".mini-game__clock--"+c).each(function(){we(this,{time:parseInt(this.getAttribute("data-time")),pause:c!=l||!Ro(o,c)})})),e.getAttribute("data-live")},Ro=(e,t)=>t=="white"?!e.includes("PPPPPPPP/RNBQKBNR"):!e.startsWith("rnbqkbnr/pppppppp"),je=e=>{let t=Array.from((e||document).getElementsByClassName("mini-game--init")),o=t.map(n=>No(n)).filter(n=>n);o.length&&U.firstConnect.then(n=>n("startWatching",o.join(" ")))},kt=(e,t)=>{let o=$(e),n=t.lm,i=Re(e.querySelector(".cg-wrap"),"chessground");i&&i.set({fen:t.fen,lastMove:me(n)});let r=ze(t.fen),s=(a,l)=>{var c;isNaN(a)||we((c=o[0])==null?void 0:c.querySelector(".mini-game__clock--"+l),{time:a,pause:l!=r||!Ro(t.fen,l)})};s(t.wc,"white"),s(t.bc,"black")},Tt=(e,t)=>["white","black"].forEach(o=>{let n=e.querySelector(".mini-game__clock--"+o);n&&!n.dataset.managed&&$(n).replaceWith(`<span class="mini-game__result">${t?t===o[0]?1:0:"\xBD"}</span>`)});function qo(e,t){if(t.length)if(e.includes("%s"))e=e.replace("%s",t[0]);else for(let o=0;o<t.length;o++)e=e.replace("%"+(o+1)+"$s",t[o]);return e}function Bo(e,t){let o=e.split(/(%(?:\d\$)?s)/g);if(t.length){let n=o.indexOf("%s");if(n!==-1)o[n]=t[0];else for(let i=0;i<t.length;i++){let r=o.indexOf("%"+(i+1)+"$s");r!==-1&&(o[r]=t[i])}}return o}var Pt=e=>{let t=(n,...i)=>{let r=e[n];return r?qo(r,i):n},o=(n,i)=>e[`${n}:${lichess.quantity(i)}`]||e[`${n}:other`]||e[n]||e[`${n}:one`];return t.pluralSame=(n,i,...r)=>t.plural(n,i,i,...r),t.plural=function(n,i,...r){let s=o(n,i);return s?qo(s,r):n},t.noarg=n=>e[n]||n,t.vdom=(n,...i)=>{let r=e[n];return r?Bo(r,i):[n]},t.vdomPlural=(n,i,...r)=>{let s=o(n,i);return s?Bo(s,r):[n]},t},te=Pt(lichess.siteI18n);var Ci=[["nbYearsAgo","inNbYears",60*60*24*365,1],["nbMonthsAgo","inNbMonths",60*60*24*365/12,1],["nbWeeksAgo","inNbWeeks",60*60*24*7,1],["nbDaysAgo","inNbDays",60*60*24,2],["nbHoursAgo","inNbHours",60*60,1],["nbMinutesAgo","inNbMinutes",60,1],["nbSecondsAgo","inNbSeconds",1,9],["rightNow","justNow",1,0]],Ko=e=>e instanceof Date?e:new Date(isNaN(e)?e:parseInt(e)),Uo=e=>{let t=Math.abs(e),o=Ci.find(n=>t>=n[2]*n[3]);return te.pluralSame(o[e<0?1:0],Math.floor(t/o[2]))},Wo,Ct=()=>Wo=Wo||(window.Intl&&Intl.DateTimeFormat?new Intl.DateTimeFormat(document.documentElement.lang,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}).format:e=>e.toLocaleString()),zo=e=>Uo((Date.now()-Ko(e).getTime())/1e3),Mt=e=>requestAnimationFrame(()=>{let t=Date.now();[].slice.call((e||document).getElementsByClassName("timeago"),0,99).forEach(o=>{let n=o.classList,i=n.contains("abs"),r=n.contains("set");if(o.lichessDate=o.lichessDate||Ko(o.getAttribute("datetime")),!r){let s=Ct()(o.lichessDate);i?o.textContent=s:o.setAttribute("title",s),n.add("set"),(i||n.contains("once"))&&n.remove("timeago")}if(!i){let s=(t-o.lichessDate.getTime())/1e3;o.textContent=Uo(s),Math.abs(s)>9999&&n.remove("timeago")}})}),St=e=>{Mt(),setTimeout(()=>St(e*1.1),e)};var oe=(e,t)=>{window.requestIdleCallback?window.requestIdleCallback(e,t?{timeout:t}:void 0):requestAnimationFrame(e)},Xe=e=>/[&<>"']/.test(e)?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;"):e;var Ye,At=()=>{Ye&&clearTimeout(Ye),Ye=void 0,$("#announce").remove()},Si=e=>{At(),e.msg&&($("body").append('<div id="announce" class="announce">'+Xe(e.msg)+(e.date?'<time class="timeago" datetime="'+e.date+'"></time>':"")+'<div class="actions"><a class="close">\xD7</a></div></div>').find("#announce .close").on("click",At),Ye=setTimeout(At,e.date?new Date(e.date).getTime()-Date.now():5e3),e.date&&lichess.contentLoaded())},Pe=Si;function Vo(){$("#agreement form").on("submit",e=>{let t=e.target;return Lo(t),t.parentNode.remove(),!1})}var de={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"};for(let e=1;e<20;++e)de[111+e]="f"+e;for(let e=0;e<=9;++e)de[e+96]=e.toString();var Ai={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Ei={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},$i=e=>{if(e.type=="keypress"){let t=String.fromCharCode(e.which);return e.shiftKey?t:t.toLowerCase()}return de[e.which]||Ai[e.which]||String.fromCharCode(e.which).toLowerCase()},Li=(e,t)=>e.sort().join(",")===t.sort().join(","),_i=e=>{let t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t},Fo=e=>e=="shift"||e=="ctrl"||e=="alt"||e=="meta",Di=(()=>{let e;return()=>{if(!e){e={};for(let t in de)parseInt(t,10)>95&&parseInt(t,10)<112||Object.prototype.hasOwnProperty.call(de,t)&&(e[de[t]]=t)}return e}})(),Ii=(e,t,o)=>(o=o||(Di()[e]?"keydown":"keypress"),o=="keypress"&&t.length?"keydown":o),Oi=e=>e==="+"?["+"]:e.replace(/\+{2}/g,"+plus").split("+"),Hi=(e,t)=>{let o,n=[];for(o of Oi(e))o=Ei[o]||o,Fo(o)&&n.push(o);return{key:o,modifiers:n,action:Ii(o,n,t)}},Ce=class{constructor(t){this.bindings={};this.bind=(t,o,n)=>(this.bindMultiple(t instanceof Array?t:[t],o,n),this);this.bindMultiple=(t,o,n)=>{for(let i of t)this.bindSingle(i,o,n)};this.bindSingle=(t,o,n)=>{let i=Hi(t,n);(this.bindings[i.key]=this.bindings[i.key]||[]).push({combination:t,callback:o,modifiers:i.modifiers,action:i.action})};this.handleKeyEvent=t=>{typeof t.which!="number"&&(t.which=t.keyCode);let o=t.target;for(let n of this.getMatches(t))(n.combination=="esc"||o.tagName!="INPUT"&&o.tagName!="SELECT"&&o.tagName!="TEXTAREA"&&!o.isContentEditable&&!o.hasAttribute("trap-bypass"))&&(n.callback(t),t.preventDefault(),t.stopPropagation())};this.getMatches=t=>{let o=$i(t),n=t.type,i=n=="keyup"&&Fo(o)?[o]:_i(t);return(this.bindings[o]||[]).filter(r=>n==r.action&&(n=="keypress"&&!t.metaKey&&!t.ctrlKey||Li(i,r.modifiers)))};t=t||document,t.addEventListener("keypress",o=>this.handleKeyEvent(o)),t.addEventListener("keydown",o=>this.handleKeyEvent(o)),t.addEventListener("keyup",o=>this.handleKeyEvent(o))}};var jo='<div class="spinner" aria-label="loading"><svg viewBox="-2 -2 54 54"><g mask="url(#mask)" fill="none"><path id="a" stroke-width="3.779" d="m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"/><path id="b" stroke-width="4.157" d="m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"/><path id="c" stroke-width="4.535" d="m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"/></g></svg></div>';var Qo=e=>{var t;return(t=document.querySelector(".crosstable"))==null?void 0:t.contains(e)},Jo=(e,t)=>o=>{let n=(o.dataset.href||o.href).replace(/\?.+$/,"");t&&t(n),D(n+"/mini").then(i=>{let r=document.getElementById(e);r.innerHTML=i,lichess.contentLoaded(r)})},Et=(e,t)=>`<a class="btn-rack__btn" href="${e}" data-icon="${t}"></a>`,$t=(e,t)=>$(e).removeClass("ulpt").powerTip({preRender:Jo("powerTip",o=>{let n=o.slice(3),i=e.dataset.name||$(e).html();$("#powerTip").html('<div class="upt__info"><div class="upt__info__top"><span class="user-link offline">'+i+'</span></div></div><div class="upt__actions btn-rack">'+Et("/@/"+n+"/tv",He)+Et("/inbox/new?user="+n,vo)+Et("/?user="+n+"#friend",mo)+'<a class="btn-rack__btn relation-button" disabled></a></div>')}),placement:t||e.getAttribute("data-pt-pos")||(Qo(e)?"n":"s")}),Lt=e=>$(e).removeClass("glpt").powerTip({preRender:Jo("miniGame",()=>lichess.spinnerHtml),placement:Qo(e)?"n":"w",popupId:"miniGame"});function Go(e,t,o){"ontouchstart"in window||(o(e),$.powerTip.show(e,t))}function Xo(e,t,o){oe(()=>Array.prototype.forEach.call(e.querySelectorAll(t),n=>o(n)),800)}var Ni={watchMouse(){document.body.addEventListener("mouseover",e=>{let t=e.target;t.classList.contains("ulpt")?Go(t,e,$t):t.classList.contains("glpt")&&Go(t,e,Lt)})},manualGameIn(e){Xo(e,".glpt",Lt)},manualGame:Lt,manualUser:$t,manualUserIn(e){Xo(e,".ulpt",$t)}},Qe=Ni,f={scoped:{},currentX:0,currentY:0,previousX:0,previousY:0,mouseTrackingActive:!1,delayInProgress:!1,windowWidth:0,windowHeight:0,scrollTop:0,scrollLeft:0},ue={none:0,top:1,bottom:2,left:4,right:8};$.fn.powerTip=function(e){if(!this.length)return this;let t=Object.assign({},Ri,e),o=new It(t);return Wi(),this.each((n,i)=>{let r=$(i);"displayController"in i&&$.powerTip.destroy(r),i.displayController=new Dt(r,t,o)}),this.on({mouseenter:function(n){$.powerTip.show(this,n)},mouseleave:function(){$.powerTip.hide(this)}}),this};var Ri={popupId:"powerTip",intentSensitivity:7,intentPollInterval:150,closeDelay:150,placement:"n",smartPlacement:!0,defaultSize:[260,120],offset:10},qi={n:["n","ne","nw","s"],e:["e","ne","se","w","nw","sw","n","s","e"],s:["s","se","sw","n"],w:["w","nw","sw","e","ne","se","n","s","w"],nw:["nw","w","sw","n","s","se","nw"],ne:["ne","e","se","n","s","sw","ne"],sw:["sw","w","nw","s","n","ne","sw"],se:["se","e","ne","s","n","nw","se"]};$.powerTip={show(e,t){return t?(Zo(t),f.previousX=t.pageX,f.previousY=t.pageY,e.displayController.show()):e.displayController.show(!0,!0),e},reposition(e){return e.displayController.resetPosition(),e},hide(e,t){return e.displayController.hide(t),e},destroy(e){return $(e).off(".powertip").each(()=>{delete this.displayController,delete this.hasActiveHover,delete this.forcedOpen}),e}};$.powerTip.showTip=$.powerTip.show;$.powerTip.closeTip=$.powerTip.hide;function _t(){return{left:"auto",top:"auto",right:"auto",bottom:"auto"}}var Dt=class{constructor(t,o,n){this.element=t;this.options=o;this.tipController=n;this.scoped={};this.el=$as(t),this.scoped=f.scoped[o.popupId]}show(t,o){this.cancel(),this.el.hasActiveHover||(t?(o&&(this.el.forcedOpen=!0),this.tipController.showTip(this.element)):(this.scoped.tipOpenImminent=!0,this.hoverTimer=setTimeout(()=>{this.hoverTimer=void 0,this.checkForIntent()},this.options.intentPollInterval)))}hide(t){this.cancel(),this.scoped.tipOpenImminent=!1,this.el.hasActiveHover&&(this.el.forcedOpen=!1,t?this.tipController.hideTip(this.element):(this.scoped.delayInProgress=!0,this.hoverTimer=setTimeout(()=>{this.hoverTimer=void 0,this.tipController.hideTip(this.element),f.delayInProgress=!1},this.options.closeDelay)))}checkForIntent(){var i;let t=Math.abs(f.previousX-f.currentX),o=Math.abs(f.previousY-f.currentY);t+o<((i=this.options.intentSensitivity)!=null?i:0)?this.tipController.showTip(this.element):(f.previousX=f.currentX,f.previousY=f.currentY,this.show())}cancel(){clearTimeout(this.hoverTimer),this.scoped.delayInProgress=!1}resetPosition(){this.tipController.resetPosition(this.element)}};function Bi(){return{compute(t,o,n,i,r){let s=o.split("-")[0],a=_t(),l=e(t,s);switch(o){case"n":a.left=l.left-n/2,a.bottom=f.windowHeight-l.top+r;break;case"e":a.left=l.left+r,a.top=l.top-i/2;break;case"s":a.left=l.left-n/2,a.top=l.top+r;break;case"w":a.top=l.top-i/2,a.right=f.windowWidth-l.left+r;break;case"nw":a.bottom=f.windowHeight-l.top+r,a.right=f.windowWidth-l.left-20;break;case"ne":a.left=l.left-20,a.bottom=f.windowHeight-l.top+r;break;case"sw":a.top=l.top+r,a.right=f.windowWidth-l.left-20;break;case"se":a.left=l.left-20,a.top=l.top+r;break}return a}};function e(t,o){let n=t.offset(),i=t.outerWidth(),r=t.outerHeight(),s=0,a=0;switch(o){case"n":s=n.left+i/2,a=n.top;break;case"e":s=n.left+i,a=n.top+r/2;break;case"s":s=n.left+i/2,a=n.top+r;break;case"w":s=n.left,a=n.top+r/2;break;case"nw":s=n.left,a=n.top;break;case"ne":s=n.left+i,a=n.top;break;case"sw":s=n.left,a=n.top+r;break;case"se":s=n.left+i,a=n.top+r;break}return{left:s,top:a}}}var It=class{constructor(t){this.options=t;this.placementCalculator=Bi();var o,n,i;if(this.tipElement=$("#"+t.popupId),this.scoped=(i=(o=f.scoped)[n=t.popupId])!=null?i:o[n]={},this.tipElement.length===0){let r=document.createElement("div");r.id=t.popupId,this.tipElement=$(r),$("body").append(this.tipElement)}this.tipElement.on({mouseenter:()=>{this.scoped.activeHover&&this.scoped.activeHover[0].displayController.cancel()},mouseleave:()=>{this.scoped.activeHover&&this.scoped.activeHover[0].displayController.hide()}})}showTip(t){$as(t).hasActiveHover=!0,this.doShowTip(t)}doShowTip(t){if($as(t).hasActiveHover){if(this.scoped.isTipOpen){this.scoped.isClosing||this.hideTip(this.scoped.activeHover),setTimeout(()=>{this.doShowTip(t)},100);return}this.tipElement.empty(),this.options.preRender&&this.options.preRender($as(t)),this.scoped.activeHover=t,this.scoped.isTipOpen=!0,this.resetPosition(t),this.tipElement.show(),this.scoped.desyncTimeout||(this.scoped.desyncTimeout=setInterval(()=>this.closeDesyncedTip(),500))}}hideTip(t){this.scoped.isClosing=!0,this.scoped.activeHover=null,this.scoped.isTipOpen=!1,this.scoped.desyncTimeout=clearInterval(this.scoped.desyncTimeout),$as(t).hasActiveHover=!1,$as(t).forcedOpen=!1,this.tipElement.hide();let o=_t();this.scoped.isClosing=!1,this.tipElement.removeClass(),o.top=f.currentY+this.options.offset,o.left=f.currentX+this.options.offset,this.tipElement.css(o)}resetPosition(t){let o;this.options.smartPlacement?(o=qi[this.options.placement],$.each(o,(n,i)=>{if(Ki(this.placeTooltip(t,i),this.tipElement.outerWidth()||this.options.defaultSize[0],this.tipElement.outerHeight()||this.options.defaultSize[1])===ue.none)return!1})):this.placeTooltip(t,this.options.placement)}placeTooltip(t,o){let n=0,i,r,s=_t();s.top=0,s.left=0,this.tipElement.css(s);do i=this.tipElement.outerWidth()||this.options.defaultSize[0],r=this.tipElement.outerHeight()||this.options.defaultSize[1],s=this.placementCalculator.compute(t,o,i,r,this.options.offset),this.tipElement.css(s);while(++n<=5&&(i!==this.tipElement.outerWidth()||r!==this.tipElement.outerHeight()));return s}closeDesyncedTip(){let t=!1;this.scoped.isTipOpen&&!this.scoped.isClosing&&!this.scoped.delayInProgress&&(this.scoped.activeHover[0].hasActiveHover===!1||this.scoped.activeHover.is(":disabled")?t=!0:!Yo(this.scoped.activeHover)&&!this.scoped.activeHover.is(":focus")&&!this.scoped.activeHover[0].forcedOpen&&(Yo(this.tipElement)||(t=!0)),t&&this.hideTip(this.scoped.activeHover))}};function Wi(){if(!f.mouseTrackingActive){f.mouseTrackingActive=!0;let e=$(window);f.scrollLeft=window.scrollX,f.scrollTop=window.scrollY,f.windowWidth=e.width(),f.windowHeight=e.height(),document.addEventListener("mousemove",Zo),window.addEventListener("resize",function(){f.windowWidth=e.width(),f.windowHeight=e.height()},{passive:!0}),window.addEventListener("scroll",function(){let t=window.scrollX,o=window.scrollY;t!==f.scrollLeft&&(f.currentX+=t-f.scrollLeft,f.scrollLeft=t),o!==f.scrollTop&&(f.currentY+=o-f.scrollTop,f.scrollTop=o)},{passive:!0})}}function Zo(e){f.currentX=e.pageX,f.currentY=e.pageY}function Yo(e){let t=e.offset();return f.currentX>=t.left&&f.currentX<=t.left+e.width()&&f.currentY>=t.top&&f.currentY<=t.top+e.height()}function Ki(e,t,o){let n=f.scrollTop,i=f.scrollLeft,r=n+f.windowHeight,s=i+f.windowWidth,a=ue.none;return(e.top<n||Math.abs(Number(e.bottom)-f.windowHeight)-o<n)&&(a|=ue.top),(Number(e.top)+o>r||Math.abs(Number(e.bottom)-f.windowHeight)>r)&&(a|=ue.bottom),(e.left<i||Number(e.right)+t>s)&&(a|=ue.left),(Number(e.left)+t>s||e.right<i)&&(a|=ue.right),a}var en=()=>window.matchMedia("(prefers-color-scheme: light)").media!=="not all";var z=(e,t={})=>{t=t||{};let o=t.sameDomain?"":document.body.getAttribute("data-asset-url"),n=t.version||document.body.getAttribute("data-asset-version");return o+"/assets"+(t.noVersion?"":"/_"+n)+"/"+e},Ot=new Map,Je=(e,t)=>{if(!Ot.has(e)){let o=document.createElement("link");o.rel="stylesheet",o.href=z(lichess.debug?`${e}?_=${Date.now()}`:e),t&&(o.media=`(prefers-color-scheme: ${t})`),Ot.set(e,new Promise(n=>{o.onload=()=>n()})),document.head.append(o)}return Ot.get(e)},ne=async e=>{let t=document.body.dataset.theme,o=(n,i)=>Je(`css/${e}.${document.dir||"ltr"}.${n}.${document.body.dataset.dev?"dev":"min"}.css`,i);t==="system"?en()?await Promise.all([o("dark","dark"),o("light","light")]):await o("dark"):await o(t)},Me=e=>`compiled/${e}${document.body.dataset.dev?"":".min"}.js`,Ht=new Map,Nt=(e,t={})=>(Ht.has(e)||Ht.set(e,Eo(z(e,t))),Ht.get(e));async function Q(e,t){let o=await import(z(Me(e),t==null?void 0:t.url));return o.initModule?o.initModule(t==null?void 0:t.init):o.default(t==null?void 0:t.init)}var Ze=async e=>(ne("complete"),Q("userComplete",{init:e})),tn=()=>(Je("npm/hopscotch/dist/css/hopscotch.min.css"),Nt("npm/hopscotch/dist/js/hopscotch.min.js",{noVersion:!0}));var et=Object.create(null),Ui={on(e,t){(et[e]=et[e]||[]).push(t)},off(e,t){let o=et[e];if(o){for(let n in o)if(o[n]===t){o.splice(Number(n),1);break}}},emit(e,...t){for(let o of et[e]||[])o.apply(null,t)}},b=Ui;var Se=e=>{let t=Vi();if(!e||!t)return t;let o=parseFloat(navigator.userAgent.slice(navigator.userAgent.indexOf("Version/")+8));return e!=null&&e.below&&(t=o<e.below),t&&(e!=null&&e.atLeast)&&(t=o>=e.atLeast),t};var zi=()=>(navigator==null?void 0:navigator.maxTouchPoints)>2&&/iPad|Macintosh/.test(navigator.userAgent),Vi=xe(()=>/iPhone|iPod/.test(navigator.userAgent)||zi()),Ma=xe(()=>window.matchMedia("(hover: hover) and (pointer: fine)").matches);function Fi(e){let t,o;return function(...n){let i=this,r=()=>{o=void 0,t=e.apply(i,n).finally(()=>{t=void 0,o&&o()})};t?o=r:r()}}function Rt(e,t){return Fi(function(...o){return t.apply(this,o),new Promise(n=>setTimeout(n,e))})}var ji=[8,1,-8,-1],Gi=[9,-9,7,-7],Da=ji.concat(Gi);var qt=e=>({P:"pawn",N:"knight",B:"bishop",R:"rook",Q:"queen",K:"king"})[e];var nn=new class{constructor(){this.ctx=Bt();this.sounds=new Map;this.paths=new Map;this.theme=document.body.dataset.soundSet;this.speechStorage=L.boolean("speech.enabled");this.volumeStorage=L.make("sound-volume");this.baseUrl=z("sound",{version:"_____1"});this.throttled=Rt(100,e=>this.play(e));this.setVolume=this.volumeStorage.set;this.getVolume=()=>{let e=parseFloat(this.volumeStorage.get()||"");return e>=0?e:.7};this.enabled=()=>this.theme!=="silent";this.speech=e=>(e!==void 0&&this.speechStorage.set(e),this.speechStorage.get());this.say=(e,t=!1,o=!1,n=!1)=>{try{if(t&&speechSynthesis.cancel(),!this.speech()&&!o)return!1;let i=new SpeechSynthesisUtterance(e);return i.volume=this.getVolume(),i.lang=n?document.documentElement.lang:"en-US",Se()||(i.onstart=r=>lichess.mic.pause(),i.onend=i.onerror=r=>lichess.mic.resume()),speechSynthesis.speak(i),!0}catch(i){return console.error(i),!1}};this.sayOrPlay=(e,t)=>this.say(t)||this.play(e);this.publish=()=>b.emit("sound_set",this.theme);this.changeSet=e=>{var t;Se()&&((t=this.ctx)==null||t.resume()),this.theme=e,this.publish()};this.set=()=>this.theme;this.primer=()=>{var e,t;if(((e=this.ctx)==null?void 0:e.state)!=="running"){let o=Bt();for(let n of this.sounds.values())n.rewire(o);(t=this.ctx)==null||t.close(),this.ctx=o}$("body").off("mouseup touchend keydown",this.primer),setTimeout(()=>$("#warn-no-autoplay").removeClass("shown"),500)};$("body").on("mouseup touchend keydown",this.primer)}async load(e,t){var s;if(!this.ctx||(t?this.paths.set(e,t):t=(s=this.paths.get(e))!=null?s:this.resolvePath(e),!t))return;if(this.sounds.has(t))return this.sounds.get(t);let o=await fetch(`${t}.mp3`);if(!o.ok)throw new Error(`${t}.mp3 failed ${o.status}`);let n=await o.arrayBuffer(),i=await new Promise((a,l)=>{var c,u,p;((c=this.ctx)==null?void 0:c.decodeAudioData.length)===1?(u=this.ctx)==null||u.decodeAudioData(n).then(a).catch(l):(p=this.ctx)==null||p.decodeAudioData(n,a,l)}),r=new Wt(this.ctx,i);return this.sounds.set(t,r),r}resolvePath(e){if(!this.enabled())return;let t=this.theme;if(this.theme==="music"||this.speech()){if(["move","capture","check"].includes(e))return;t="standard"}return`${this.baseUrl}/${t}/${e[0].toUpperCase()+e.slice(1)}`}async play(e,t=1){if(!this.enabled())return;let o=await this.load(e);o&&await this.resumeContext()&&await o.play(this.getVolume()*t)}async move(e){var t,o,n,i;(e==null?void 0:e.filter)!=="music"&&this.theme!=="music"&&(e!=null&&e.name?this.throttled(e.name):((t=e==null?void 0:e.san)!=null&&t.includes("x")?this.throttled("capture"):this.throttled("move"),((o=e==null?void 0:e.san)!=null&&o.endsWith("#")||(n=e==null?void 0:e.san)!=null&&n.endsWith("+"))&&this.throttled("check"))),!((e==null?void 0:e.filter)==="game"||this.theme!=="music")&&((i=this.music)!=null||(this.music=await lichess.loadEsm("soundMove")),this.music(e))}async countdown(e,t=500){if(this.enabled())try{for(;e>0;){let o=[new Promise(n=>setTimeout(n,t)),this.play(`countDown${e}`)];--e>0&&o.push(this.load(`countDown${e}`)),await Promise.all(o)}await this.play("genericNotify")}catch(o){console.error(o)}}playOnce(e){let t=()=>{let o=lichess.storage.make("just-played");Date.now()-parseInt(o.get(),10)<2e3||(o.set(""+Date.now()),this.play(e))};document.hasFocus()?t():setTimeout(t,10+Math.random()*500)}saySan(e,t){let o=e?e.includes("O-O-O#")?"long castle checkmate":e.includes("O-O-O+")?"long castle check":e.includes("O-O-O")?"long castle":e.includes("O-O#")?"short castle checkmate":e.includes("O-O+")?"short castle check":e.includes("O-O")?"short castle":e.split("").map(n=>{if(n=="x")return"takes";if(n=="+")return"check";if(n=="#")return"checkmate";if(n=="=")return"promotes to";if(n=="@")return"at";let i=n.charCodeAt(0);return i>48&&i<58?n:i>96&&i<105?n.toUpperCase():qt(n)||n}).join(" ").replace(/^A /,"A, ").replace(/(\d) E (\d)/,"$1,E $2").replace(/C /,"c ").replace(/F /,"f ").replace(/(\d) H (\d)/,"$1H$2"):"Game start";this.say(o,t)}preloadBoardSounds(){for(let e of["move","capture","check","genericNotify"])this.load(e)}async resumeContext(){var e,t;if(!this.ctx)return!1;if(this.ctx.state!=="running"&&this.ctx.state!=="suspended"&&(this.ctx=Bt(),this.ctx))for(let o of this.sounds.values())o.rewire(this.ctx);return((e=this.ctx)==null?void 0:e.state)==="suspended"&&await new Promise(o=>{var i;let n=setTimeout(()=>{$("#warn-no-autoplay").addClass("shown"),o()},400);(i=this.ctx)==null||i.resume().then(()=>{clearTimeout(n),o()}).catch(o)}),((t=this.ctx)==null?void 0:t.state)!=="running"?!1:($("#warn-no-autoplay").removeClass("shown"),!0)}},Wt=class{constructor(t,o){this.buffer=o;this.rewire(t)}play(t=1){this.node.gain.setValueAtTime(t,this.ctx.currentTime);let o=this.ctx.createBufferSource();return o.buffer=this.buffer,o.connect(this.node),new Promise(n=>{o.onended=()=>{o.disconnect(),n()},o.start(0)})}rewire(t){var o;(o=this.node)==null||o.disconnect(),this.ctx=t,this.node=this.ctx.createGain(),this.node.connect(this.ctx.destination)}};function Bt(){return window.webkitAudioContext?new window.webkitAudioContext:typeof AudioContext!="undefined"?new AudioContext:void 0}async function rn(e){let t=await Xi(e);function o(i){return t.transaction(e.store,i).objectStore(e.store)}function n(i){return new Promise((r,s)=>{let a=i();a.onsuccess=l=>r(l.target.result),a.onerror=l=>s(l.target.result)})}return{get(i){return n(()=>o("readonly").get(i))},put(i,r){return n(()=>o("readwrite").put(r,i))},count(i){return n(()=>o("readonly").count(i))},remove(i){return n(()=>o("readwrite").delete(i))},clear(){return n(()=>o("readwrite").clear())},txn(i){return t.transaction(e.store,i)}}}async function Xi(e){let t=(e==null?void 0:e.db)||`${e.store}--db`;return new Promise((o,n)=>{var i;let r=window.indexedDB.open(t,(i=e==null?void 0:e.version)!==null&&i!==void 0?i:1);r.onsuccess=s=>o(s.target.result),r.onerror=s=>{var a;return n((a=s.target.result)!==null&&a!==void 0?a:"IndexedDB Unavailable")},r.onupgradeneeded=s=>{var a;let l=s.target.result,c=s.target.transaction,u=l.objectStoreNames.contains(e.store)?c.objectStore(e.store):l.createObjectStore(e.store);(a=e.upgrade)===null||a===void 0||a.call(e,s,u)}})}var ot=class{constructor(){this.group=new Map,this.key=!1}set ctx(t){var o,n,i,r;this.context!==t&&((n=(o=this.selected)===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context),this.context=t,(r=(i=this.selected)===null||i===void 0?void 0:i.select)===null||r===void 0||r.call(i,this.context))}get selected(){return this.key?this.group.get(this.key):void 0}select(t){var o,n,i,r;if(this.key){if(this.key===t)return;(n=(o=this.selected)===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context)}this.key=t,(r=(i=this.selected)===null||i===void 0?void 0:i.select)===null||r===void 0||r.call(i,this.context)}get(t){return this.group.get(t)}set(t,o){let n=this.key===t;this.close(t),this.group.set(t,o),n&&this.select(t)}close(t){var o,n,i,r;if(t===void 0){for(let s of this.group.keys())this.close(s);return}t===this.key&&((n=(o=this.group.get(t))===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context),this.key=!1),(r=(i=this.group.get(t))===null||i===void 0?void 0:i.close)===null||r===void 0||r.call(i,this.context)}delete(t){this.close(t),t?this.group.delete(t):this.group.clear()}};function Yi(e,t,o,n){let i="analyse."+e,r;return function(s){if(le(s)&&s!=r)r=s,lichess.storage.set(e,n(s));else if(!le(r)){let a=lichess.storage.get(i);ye(a)&&(lichess.storage.set(e,a),lichess.storage.remove(i));let l=lichess.storage.get(e);r=l===null?t:o(l)}return r}}var sn=(e,t)=>Yi(e,t,o=>o,o=>o);var nr;lichess.load.then(async()=>{window.addEventListener("resize",ir),window.HTMLDialogElement||(nr=(await import(lichess.assetUrl("npm/dialog-polyfill.esm.js"))).default)});function ir(){$("dialog > div.scrollable").css("--vh",`${window.innerHeight}px`)}var al=["button","input","select","textarea"].map(e=>`${e}:not(:disabled)`).concat(["[href]",'[tabindex="0"]','[role="tab"]']).join(",");var cn="_____1";var Ut=class{constructor(t,o){this.listenerMap=new Map;this.words=t,this.partial=o}select(t){!(t!=null&&t.source)||!this.node||(t.source.connect(this.node),this.node.connect(t.ctx.destination))}deselect(){var t;(t=this.node)==null||t.disconnect()}close(){this.node=void 0}get listeners(){return[...this.listenerMap.values()].reverse()}},dn=new class{constructor(){this.language="en";this.deviceId=sn("voice.micDeviceId","default");this.recs=new ot;this.recId="default";this.voskStatus="";this.busy=!1;this.interrupt=!1;this.paused=0}get lang(){return this.language}setLang(e){e!==this.language&&(this.stop(),this.language=e)}async getMics(){return navigator.mediaDevices.enumerateDevices().then(e=>e.filter(t=>t.kind=="audioinput"))}get micId(){return this.deviceId()}setMic(e){var o;let t=this.isListening;lichess.mic.stop(),this.deviceId(e),this.recs.close(),(o=this.audioCtx)==null||o.close(),this.audioCtx=void 0,t&&this.start()}setController(e){this.ctrl=e,this.ctrl("","status")}addListener(e,t={}){var n,i;let o=(n=t.recId)!=null?n:"default";if(!this.recs.group.has(o))throw`No recognizer for '${o}'`;this.recs.group.get(o).listenerMap.set((i=t.listenerId)!=null?i:o,e)}removeListener(e){this.recs.group.forEach(t=>t.listenerMap.delete(e))}initRecognizer(e,t={}){var i,r;if(e.length===0){this.recs.delete(t.recId);return}let o=(i=t.recId)!=null?i:"default",n=new Ut(e.slice(),t.partial===!0);(r=this.vosk)!=null&&r.isLoaded(this.lang)&&this.initKaldi(o,n),this.recs.set(o,n),t.listener&&this.addListener(t.listener,{recId:o,listenerId:t.listenerId})}setRecognizer(e="default"){var t;this.recId=e,this.isListening&&(this.recs.select(e),(t=this.vosk)==null||t.select(e))}async start(e=!0){var t;try{if(e&&this.isListening&&this.recId===this.recs.key)return;if(this.busy=!0,await this.initModel(),!this.busy)throw"";for(let[o,n]of this.recs.group)this.initKaldi(o,n);this.recs.select(e&&this.recId),(t=this.vosk)==null||t.select(e&&this.recId),this.micTrack.enabled=e,this.busy=!1,this.broadcast(e?"Listening...":"","start")}catch(o){if(this.stop([o.toString(),"error"]),o!=="")throw o}}stop(e=["","stop"]){var t,o;this.micTrack&&(this.micTrack.enabled=!1),(t=this.download)==null||t.abort(),this.download=void 0,this.busy=!1,this.recs.select(!1),(o=this.vosk)==null||o.select(!1),this.broadcast(...e)}pause(){var e;++this.paused!==1||!((e=this.micTrack)!=null&&e.enabled)||(this.micTrack.enabled=!1)}resume(){this.paused=Math.min(this.paused-1,0),!(this.paused!==0||this.micTrack===void 0)&&(this.micTrack.enabled=!!this.recs.selected)}get isListening(){var e;return!!this.recs.selected&&!!((e=this.micTrack)!=null&&e.enabled)&&!this.isBusy}get isBusy(){return this.busy}get status(){return this.voskStatus}stopPropagation(){this.interrupt=!0}get micTrack(){var e;return(e=this.mediaStream)==null?void 0:e.getAudioTracks()[0]}initKaldi(e,t){var o;t.node||(t.node=(o=this.vosk)==null?void 0:o.initRecognizer({recId:e,audioCtx:this.audioCtx,partial:t.partial,words:t.words,broadcast:this.broadcast.bind(this)}))}async initModel(){var n,i;if((n=this.vosk)!=null&&n.isLoaded(this.lang)){await this.initAudio();return}this.broadcast("Loading...");let e=lichess.assetUrl(ln.get(this.lang),{noVersion:!0}),t=this.downloadModel(`/vosk/${e.replace(/[\W]/g,"_")}`),o=this.initAudio();(i=this.vosk)!=null||(this.vosk=await lichess.loadEsm("voice.vosk",{url:{version:cn}})),await t,await this.vosk.initModel(e,this.lang),await o}async initAudio(){var e,t;if(((e=this.audioCtx)==null?void 0:e.state)==="suspended"&&await this.audioCtx.resume(),((t=this.audioCtx)==null?void 0:t.state)!=="running"){if(this.audioCtx)throw`Error ${this.audioCtx.state}`;this.mediaStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:{sampleRate:{ideal:16e3},echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0},deviceId:this.micId}}),this.audioCtx=new AudioContext({sampleRate:this.mediaStream.getAudioTracks()[0].getSettings().sampleRate}),this.micSource=this.audioCtx.createMediaStreamSource(this.mediaStream),this.recs.ctx={vosk:this.vosk,source:this.micSource,ctx:this.audioCtx}}}broadcast(e,t="status",o=0){var n,i,r;(n=this.ctrl)==null||n.call(this,e,t),(t==="status"||t==="full")&&window.clearTimeout(this.broadcastTimeout),this.voskStatus=e;for(let s of(r=(i=this.recs.get(this.recId))==null?void 0:i.listeners)!=null?r:[])this.interrupt||s(e,t);this.interrupt=!1,this.broadcastTimeout=o>0?window.setTimeout(()=>this.broadcast(""),o):void 0}async downloadModel(e){let t=await rn({db:"/vosk",store:"FILE_DATA",version:21,upgrade:(i,r)=>{r==null||r.createIndex("timestamp","timestamp",{unique:!1})}});if(await t.count(`${e}/extracted.ok`)>0)return;let o=await new Promise((i,r)=>{this.download=new XMLHttpRequest,this.download.open("GET",lichess.assetUrl(ln.get(this.lang),{noVersion:!0}),!0),this.download.responseType="arraybuffer",this.download.onerror=s=>r("Failed. See console"),this.download.onabort=s=>r("Aborted"),this.download.onprogress=s=>{this.broadcast(s.total<=0?"Downloading...":`Downloaded ${Math.round(100*s.loaded/s.total)}% of ${Math.round(s.total/1e6)}MB`)},this.download.onload=s=>{var a,l,c;((a=this.download)==null?void 0:a.status)!==200?r(`${(l=this.download)==null?void 0:l.status} Failed`):i((c=this.download)==null?void 0:c.response)},this.download.send()});this.broadcast("Extracting...");let n=new Date;await t.put(e,{timestamp:n,mode:16877}),await t.put(`${e}/downloaded.ok`,{contents:new Uint8Array([]),timestamp:n,mode:33206}),await t.remove(`${e}/downloaded.tar.gz`),await t.put(`${e}/downloaded.tar.gz`,{contents:new Uint8Array(o),timestamp:n,mode:33188}),t.txn("readwrite").objectStore("FILE_DATA").index("timestamp")}},ln=new Map([["ca","lifat/vosk/model-ca-0.4.tar.gz"],["cn","lifat/vosk/model-cn-0.22.tar.gz"],["cs","lifat/vosk/model-cs-0.4.tar.gz"],["de","lifat/vosk/model-de-0.15.tar.gz"],["en","lifat/vosk/model-en-us-0.15.tar.gz"],["eo","lifat/vosk/model-eo-0.42.tar.gz"],["es","lifat/vosk/model-es-0.42.tar.gz"],["fa","lifat/vosk/model-fa-0.4.tar.gz"],["fr","lifat/vosk/model-fr-0.22.tar.gz"],["hi","lifat/vosk/model-hi-0.22.tar.gz"],["it","lifat/vosk/model-it-0.22.tar.gz"],["ja","lifat/vosk/model-ja-0.22.tar.gz"],["ko","lifat/vosk/model-ko-0.22.tar.gz"],["kz","lifat/vosk/model-kz-0.15.tar.gz"],["nl","lifat/vosk/model-nl-0.22.tar.gz"],["pl","lifat/vosk/model-pl-0.22.tar.gz"],["pt","lifat/vosk/model-pt-0.3.tar.gz"],["ru","lifat/vosk/model-ru-0.22.tar.gz"],["tr","lifat/vosk/model-tr-0.3.tar.gz"],["uk","lifat/vosk/model-uk-v3.tar.gz"],["uz","lifat/vosk/model-uz-0.22.tar.gz"],["vi","lifat/vosk/model-vi-0.4.tar.gz"]]);var zt,rr=e=>e.includes(" ")?e.split(" ")[1]:e;function Ae(e){if(e.dataset.watched)return;e.dataset.watched="1";let t=$('<div class="chat__members__inner">').appendTo(e),o=$(`<div class="chat__members__number" data-icon="${wo}" title="Spectators"></div>`).appendTo(t),n=$("<div>").appendTo(t);lichess.pubsub.on("socket.in.crowd",r=>i(r.watchers||r));let i=r=>{if(zt=r,!r||!r.nb){e.classList.add("none");return}if(o.text(""+r.nb),r.users){let s=r.users.map(a=>a||"").join(";");if(n.data("prevUsers")!==s){n.data("prevUsers",s);let a=r.users.map(l=>l?`<a class="user-link ulpt" href="/@/${rr(l)}">${l}</a>`:"Anonymous");r.anons===1?a.push("Anonymous"):r.anons&&a.push(`Anonymous (${r.anons})`),n.html(a.join(", "))}}else n.html("");e.classList.remove("none")};zt&&i(zt)}var ie=(e,t)=>Math.abs(e-t),sr=e=>(t,o,n,i)=>ie(t,n)<2&&(e==="white"?i===o+1||o<=1&&i===o+2&&t===n:i===o-1||o>=6&&i===o-2&&t===n),Vt=(e,t,o,n)=>{let i=ie(e,o),r=ie(t,n);return i===1&&r===2||i===2&&r===1},un=(e,t,o,n)=>ie(e,o)===ie(t,n),pn=(e,t,o,n)=>e===o||t===n,Ft=(e,t,o,n)=>un(e,t,o,n)||pn(e,t,o,n),ar=(e,t,o)=>(n,i,r,s)=>ie(n,r)<2&&ie(i,s)<2||o&&i===s&&i===(e==="white"?0:7)&&(n===4&&(r===2&&t.includes(0)||r===6&&t.includes(7))||t.includes(r));function cr(e,t){let o=t==="white"?"1":"8",n=[];for(let[i,r]of e)i[1]===o&&r.color===t&&r.role==="rook"&&n.push(m(i)[0]);return n}function jt(e,t,o){let n=e.get(t);if(!n)return[];let i=m(t),r=n.role,s=r==="pawn"?sr(n.color):r==="knight"?Vt:r==="bishop"?un:r==="rook"?pn:r==="queen"?Ft:ar(n.color,cr(e,n.color),o);return Be.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&s(i[0],i[1],a[0],a[1])).map(P)}function M(e,...t){e&&setTimeout(()=>e(...t),1)}function fn(e){e.orientation=ge(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function hn(e,t){for(let[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}function mn(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[o,n]of e.pieces)n.role==="king"&&n.color===t&&(e.check=o)}function lr(e,t,o,n){O(e),e.premovable.current=[t,o],M(e.premovable.events.set,t,o,n)}function I(e){e.premovable.current&&(e.premovable.current=void 0,M(e.premovable.events.unset))}function dr(e,t,o){I(e),e.predroppable.current={role:t,key:o},M(e.predroppable.events.set,t,o)}function O(e){let t=e.predroppable;t.current&&(t.current=void 0,M(t.events.unset))}function ur(e,t,o){if(!e.autoCastle)return!1;let n=e.pieces.get(t);if(!n||n.role!=="king")return!1;let i=m(t),r=m(o);if(i[1]!==0&&i[1]!==7||i[1]!==r[1])return!1;i[0]===4&&!e.pieces.has(o)&&(r[0]===6?o=P([7,r[1]]):r[0]===2&&(o=P([0,r[1]])));let s=e.pieces.get(o);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(o),i[0]<r[0]?(e.pieces.set(P([6,r[1]]),n),e.pieces.set(P([5,r[1]]),s)):(e.pieces.set(P([2,r[1]]),n),e.pieces.set(P([3,r[1]]),s)),!0)}function Gt(e,t,o){let n=e.pieces.get(t),i=e.pieces.get(o);if(t===o||!n)return!1;let r=i&&i.color!==n.color?i:void 0;return o===e.selected&&C(e),M(e.events.move,t,o,r),ur(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,M(e.events.change),r||!0}function nt(e,t,o,n){if(e.pieces.has(o))if(n)e.pieces.delete(o);else return!1;return M(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,M(e.events.change),e.movable.dests=void 0,e.turnColor=ge(e.turnColor),!0}function gn(e,t,o){let n=Gt(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=ge(e.turnColor),e.animation.current=void 0),n}function Xt(e,t,o){if(rt(e,t,o)){let n=gn(e,t,o);if(n){let i=e.hold.stop();C(e);let r={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return n!==!0&&(r.captured=n),M(e.movable.events.after,t,o,r),!0}}else if(fr(e,t,o))return lr(e,t,o,{ctrlKey:e.stats.ctrlKey}),C(e),!0;return C(e),!1}function it(e,t,o,n){let i=e.pieces.get(t);i&&(pr(e,t,o)||n)?(e.pieces.delete(t),nt(e,i,o,n),M(e.movable.events.afterNewPiece,i.role,o,{premove:!1,predrop:!1})):i&&hr(e,t,o)?dr(e,i.role,o):(I(e),O(e)),e.pieces.delete(t),C(e)}function Ee(e,t,o){if(M(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){C(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==t&&Xt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(vn(e,t)||Qt(e,t))&&(Yt(e,t),e.hold.start())}function Yt(e,t){e.selected=t,Qt(e,t)?e.premovable.customDests||(e.premovable.dests=jt(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function C(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function vn(e,t){let o=e.pieces.get(t);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}var rt=(e,t,o)=>{var n,i;return t!==o&&vn(e,t)&&(e.movable.free||!!(!((i=(n=e.movable.dests)===null||n===void 0?void 0:n.get(t))===null||i===void 0)&&i.includes(o)))};function pr(e,t,o){let n=e.pieces.get(t);return!!n&&(t===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function Qt(e,t){let o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function fr(e,t,o){var n,i;let r=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(t))!==null&&i!==void 0?i:jt(e.pieces,t,e.premovable.castle);return t!==o&&Qt(e,t)&&r.includes(o)}function hr(e,t,o){let n=e.pieces.get(t),i=e.pieces.get(o);return!!n&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function bn(e,t){let o=e.pieces.get(t);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function wn(e){let t=e.premovable.current;if(!t)return!1;let o=t[0],n=t[1],i=!1;if(rt(e,o,n)){let r=gn(e,o,n);if(r){let s={premove:!0};r!==!0&&(s.captured=r),M(e.movable.events.after,o,n,s),i=!0}}return I(e),i}function yn(e,t){let o=e.predroppable.current,n=!1;if(!o)return!1;if(t(o)){let i={role:o.role,color:e.movable.color};nt(e,i,o.key)&&(M(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0)}return O(e),n}function $e(e){I(e),O(e),C(e)}function Jt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,$e(e)}function H(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let i=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(i=7-i),n>=0&&n<8&&i>=0&&i<8?P([n,i]):void 0}function xn(e,t,o,n){let i=m(e),r=Be.filter(c=>Ft(i[0],i[1],c[0],c[1])||Vt(i[0],i[1],c[0],c[1])),a=r.map(c=>Ke(P(c),o,n)).map(c=>G(t,c)),[,l]=a.reduce((c,u,p)=>c[0]<u?c:[u,p],[a[0],0]);return P(r[l])}var x=e=>e.orientation==="white";var eo="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",mr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},gr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function st(e){e==="start"&&(e=eo);let t=new Map,o=7,n=0;for(let i of e)switch(i){case" ":case"[":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{let r=t.get(P([n-1,o]));r&&(r.promoted=!0);break}default:{let r=i.charCodeAt(0);if(r<57)n+=r-48;else{let s=i.toLowerCase();t.set(P([n,o]),{role:mr[s],color:i===s?"black":"white"}),++n}}}return t}function kn(e){return Po.map(t=>ae.map(o=>{let n=e.get(o+t);if(n){let i=gr[n.role];return n.color==="white"&&(i=i.toUpperCase()),n.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function to(e,t){t.animation&&(oo(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function at(e,t){var o,n,i;if(!((o=t.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((n=t.drawable)===null||n===void 0)&&n.autoShapes&&(e.drawable.autoShapes=[]),oo(e,t),t.fen&&(e.pieces=st(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&mn(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Yt(e,e.selected),to(e,t),!e.movable.rookCastle&&e.movable.dests){let r=e.movable.color==="white"?"1":"8",s="e"+r,a=e.movable.dests.get(s),l=e.pieces.get(s);if(!a||!l||l.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+r&&a.includes("c"+r))&&!(c==="h"+r&&a.includes("g"+r))))}}function oo(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&Tn(e[o])&&Tn(t[o])?oo(e[o],t[o]):e[o]=t[o])}function Tn(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var V=(e,t)=>t.animation.enabled?yr(e,t):F(e,t);function F(e,t){let o=e(t);return t.dom.redraw(),o}var no=(e,t)=>({key:e,pos:m(e),piece:t}),br=(e,t)=>t.sort((o,n)=>G(e.pos,o.pos)-G(e.pos,n.pos))[0];function wr(e,t){let o=new Map,n=[],i=new Map,r=[],s=[],a=new Map,l,c,u;for(let[p,y]of e)a.set(p,no(p,y));for(let p of qe)l=t.pieces.get(p),c=a.get(p),l?c?ve(l,c.piece)||(r.push(c),s.push(no(p,l))):s.push(no(p,l)):c&&r.push(c);for(let p of s)c=br(p,r.filter(y=>ve(p.piece,y.piece))),c&&(u=[c.pos[0]-p.pos[0],c.pos[1]-p.pos[1]],o.set(p.key,u.concat(u)),n.push(c.key));for(let p of r)n.includes(p.key)||i.set(p.key,p.piece);return{anims:o,fadings:i}}function Pn(e,t){let o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}let n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{let i=xr(n);for(let r of o.plan.anims.values())r[2]=r[0]*i,r[3]=r[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((r=performance.now())=>Pn(e,r))}}function yr(e,t){let o=new Map(t.pieces),n=e(t),i=wr(o,t);if(i.anims.size||i.fadings.size){let r=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},r||Pn(t,performance.now())}else t.dom.redraw();return n}var xr=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var kr=["green","red","blue","yellow"];function Cn(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?C(e):$e(e);let o=W(t),n=H(o,x(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:Tr(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Mn(e))}function Mn(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let o=H(t.pos,x(e),e.dom.bounds());o||(t.snapToValidMove=!1);let n=t.snapToValidMove?xn(t.orig,t.pos,x(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),Mn(e)}})}function Sn(e,t){e.drawable.current&&(e.drawable.current.pos=W(t))}function An(e){let t=e.drawable.current;t&&(t.mouseSq&&Pr(e.drawable,t),io(e))}function io(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function En(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),$n(e.drawable))}function Tr(e){var t;let o=(e.shiftKey||e.ctrlKey)&&We(e),n=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return kr[(o?1:0)+(n?2:0)]}function Pr(e,t){let o=i=>i.orig===t.orig&&i.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter(i=>!o(i))),(!n||n.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),$n(e)}function $n(e){e.onChange&&e.onChange(e.shapes)}function Ln(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let o=e.dom.bounds(),n=W(t),i=H(n,x(e),o);if(!i)return;let r=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!r||r.color!==e.turnColor)&&En(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||r||s||Mr(e,n)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&rt(e,e.selected,i)?V(p=>Ee(p,i),e):Ee(e,i);let c=e.selected===i,u=Hn(e,i);if(r&&u&&c&&bn(e,i)){e.draggable.current={orig:i,piece:r,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");let p=e.dom.elements.ghost;p&&(p.className=`ghost ${r.color} ${r.role}`,A(p,X(o)(m(i),x(e))),be(p,!0)),ro(e)}else a&&I(e),l&&O(e);e.dom.redraw()}function Mr(e,t){let o=x(e),n=e.dom.bounds(),i=Math.pow(n.width/8,2);for(let r of e.pieces.keys()){let s=Ke(r,o,n);if(G(s,t)<=i)return!0}return!1}function _n(e,t,o,n){let i="a0";e.pieces.set(i,t),e.dom.redraw();let r=W(o);e.draggable.current={orig:i,piece:t,origPos:r,pos:r,started:!0,element:()=>Hn(e,i),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},ro(e)}function ro(e){requestAnimationFrame(()=>{var t;let o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);let n=e.pieces.get(o.orig);if(!n||!ve(n,o.piece))re(e);else if(!o.started&&G(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let r=o.element();if(!r)return;r.cgDragging=!0,r.classList.add("dragging"),o.element=r}let i=e.dom.bounds();A(o.element,[o.pos[0]-i.left-i.width/16,o.pos[1]-i.top-i.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==H(o.pos,x(e),i))}ro(e)})}function Dn(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=W(t))}function In(e,t){let o=e.draggable.current;if(!o)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&o.originTarget!==t.target&&!o.newPiece){e.draggable.current=void 0;return}I(e),O(e);let n=W(t)||o.pos,i=H(n,x(e),e.dom.bounds());i&&o.started&&o.orig!==i?o.newPiece?it(e,o.orig,i,o.force):(e.stats.ctrlKey=t.ctrlKey,Xt(e,o.orig,i)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(o.orig),M(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===i||!i)?C(e):e.selectable.enabled||C(e),On(e),e.draggable.current=void 0,e.dom.redraw()}function re(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,C(e),On(e),e.dom.redraw())}function On(e){let t=e.dom.elements;t.ghost&&be(t.ghost,!1)}function Hn(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}function Rn(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Nn(e,2),setTimeout(()=>Nn(e,void 0),120)},120)}function Nn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function qn(e,t){function o(){fn(e),t()}return{set(n){n.orientation&&n.orientation!==e.orientation&&o(),to(e,n),(n.fen?V:F)(i=>at(i,n),e)},state:e,getFen:()=>kn(e.pieces),toggleOrientation:o,setPieces(n){V(i=>hn(i,n),e)},selectSquare(n,i){n?V(r=>Ee(r,n,i),e):e.selected&&(C(e),e.dom.redraw())},move(n,i){V(r=>Gt(r,n,i),e)},newPiece(n,i){V(r=>nt(r,n,i),e)},playPremove(){if(e.premovable.current){if(V(wn,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){let i=yn(e,n);return e.dom.redraw(),i}return!1},cancelPremove(){F(I,e)},cancelPredrop(){F(O,e)},cancelMove(){F(n=>{$e(n),re(n)},e)},stop(){F(n=>{Jt(n),re(n)},e)},explode(n){Rn(e,n)},setAutoShapes(n){F(i=>i.drawable.autoShapes=n,e)},setShapes(n){F(i=>i.drawable.shapes=n,e)},getKeyAtDomPos(n){return H(n,x(e),e.dom.bounds())},redrawAll:t,dragNewPiece(n,i,r){_n(e,n,i,r)},destroy(){Jt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Bn(){return{pieces:st(eo),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Mo()}}var Wn={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function zn(){let e=k("defs"),t=T(k("filter"),{id:"cg-filter-blur"});return t.appendChild(T(k("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Vn(e,t,o){var n;let i=e.drawable,r=i.current,s=r&&r.mouseSq?r:void 0,a=new Map,l=e.dom.bounds(),c=i.autoShapes.filter(v=>!v.piece);for(let v of i.shapes.concat(c).concat(s?[s]:[])){if(!v.dest)continue;let g=(n=a.get(v.dest))!==null&&n!==void 0?n:new Set,h=dt(lt(m(v.orig),e.orientation),l),N=dt(lt(m(v.dest),e.orientation),l);g.add(ao(h,N)),a.set(v.dest,g)}let u=i.shapes.concat(c).map(v=>({shape:v,current:!1,hash:Kn(v,so(v.dest,a),!1,l)}));s&&u.push({shape:s,current:!0,hash:Kn(s,so(s.dest,a),!0,l)});let p=u.map(v=>v.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;let y=t.querySelector("defs");Ar(i,u,y),Er(u,t.querySelector("g"),o.querySelector("g"),v=>_r(e,v,i.brushes,a,l))}function Ar(e,t,o){var n;let i=new Map,r;for(let l of t.filter(c=>c.shape.dest&&c.shape.brush))r=Fn(e.brushes[l.shape.brush],l.shape.modifiers),!((n=l.shape.modifiers)===null||n===void 0)&&n.hilite&&i.set(ct(r).key,ct(r)),i.set(r.key,r);let s=new Set,a=o.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(let[l,c]of i.entries())s.has(l)||o.appendChild(Or(c))}function Er(e,t,o,n){let i=new Map;for(let r of e)i.set(r.hash,!1);for(let r of[t,o]){let s=[],a=r.firstElementChild,l;for(;a;)l=a.getAttribute("cgHash"),i.has(l)?i.set(l,!0):s.push(a),a=a.nextElementSibling;for(let c of s)r.removeChild(c)}for(let r of e.filter(s=>!i.get(s.hash)))for(let s of n(r))s.isCustom?o.appendChild(s.el):t.appendChild(s.el)}function Kn({orig:e,dest:t,brush:o,piece:n,modifiers:i,customSvg:r,label:s},a,l,c){var u,p;return[c.width,c.height,l,e,t,o,a&&"-",n&&$r(n),i&&Lr(i),r&&`custom-${Un(r.html)},${(p=(u=r.center)===null||u===void 0?void 0:u[0])!==null&&p!==void 0?p:"o"}`,s&&`label-${Un(s.text)}`].filter(y=>y).join(",")}function $r(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Lr(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Un(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return t.toString()}function _r(e,{shape:t,current:o,hash:n},i,r,s){var a,l;let c=dt(lt(m(t.orig),e.orientation),s),u=t.dest?dt(lt(m(t.dest),e.orientation),s):c,p=t.brush&&Fn(i[t.brush],t.modifiers),y=r.get(t.dest),v=[];if(p){let g=T(k("g"),{cgHash:n});v.push({el:g}),c[0]!==u[0]||c[1]!==u[1]?g.appendChild(Ir(t,p,c,u,o,so(t.dest,r))):g.appendChild(Dr(i[t.brush],c,o,s))}if(t.label){let g=t.label;(a=g.fill)!==null&&a!==void 0||(g.fill=t.brush&&i[t.brush].color);let h=t.brush?void 0:"tr";v.push({el:Hr(g,n,c,u,y,h),isCustom:!0})}if(t.customSvg){let g=(l=t.customSvg.center)!==null&&l!==void 0?l:"orig",[h,N]=g==="label"?Gn(c,u,y).map(S=>S-.5):g==="dest"?u:c,_=T(k("g"),{transform:`translate(${h},${N})`,cgHash:n});_.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,v.push({el:_,isCustom:!0})}return v}function Dr(e,t,o,n){let i=Nr(),r=(n.width+n.height)/(4*Math.max(n.width,n.height));return T(k("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:jn(e,o),cx:t[0],cy:t[1],r:r-i[1]/2})}function ct(e){return["#ffffff","#fff","white"].includes(e.color)?Wn.hilitePrimary:Wn.hiliteWhite}function Ir(e,t,o,n,i,r){var s;function a(u){var p;let y=qr(r&&!i),v=n[0]-o[0],g=n[1]-o[1],h=Math.atan2(g,v),N=Math.cos(h)*y,_=Math.sin(h)*y;return T(k("line"),{stroke:u?ct(t).color:t.color,"stroke-width":Rr(t,i)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?ct(t).key:t.key})`,opacity:!((p=e.modifiers)===null||p===void 0)&&p.hilite?1:jn(t,i),x1:o[0],y1:o[1],x2:n[0]-N,y2:n[1]-_})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);let l=k("g"),c=T(k("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(Br(o,n)),c.appendChild(a(!0)),l.appendChild(c),l.appendChild(a(!1)),l}function Or(e){let t=T(k("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(T(k("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Hr(e,t,o,n,i,r){var s;let l=.4*.75**e.text.length,c=Gn(o,n,i),u=r==="tr"?.4:0,p=T(k("g"),{transform:`translate(${c[0]+u},${c[1]-u})`,cgHash:t});p.appendChild(T(k("circle"),{r:.4/2,"fill-opacity":r?1:.8,"stroke-opacity":r?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));let y=T(k("text"),{"font-size":l,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return y.innerHTML=e.text,p.appendChild(y),p}function lt(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function so(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function k(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function T(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function Fn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(o=>o).join("")}:e}function Nr(){return[3/64,4/64]}function Rr(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function jn(e,t){return(e.opacity||1)*(t?.9:1)}function qr(e){return(e?20:10)/64}function dt(e,t){let o=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*n]}function Br(e,t){let o={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return T(k("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}function ao(e,t,o=!0){let n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return o?(Math.round(n*8/Math.PI)+16)%16:n}function Wr(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((o,n)=>o+n*n,0))}function Gn(e,t,o){let n=Wr(e,t),i=ao(e,t,!1);if(o&&(n-=33/64,o.size>1)){n-=10/64;let r=ao(e,t);(o.has((r+1)%16)||o.has((r+15)%16))&&r&1&&(n-=.4)}return[e[0]-Math.cos(i)*n,e[1]-Math.sin(i)*n].map(r=>r+.5)}function Yn(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let l of ko)e.classList.toggle("orientation-"+l,t.orientation===l);e.classList.toggle("manipulable",!t.viewOnly);let o=E("cg-container");e.appendChild(o);let n=E("cg-board");o.appendChild(n);let i,r,s;if(t.drawable.visible&&(i=T(k("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(zn()),i.appendChild(k("g")),r=T(k("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(k("g")),s=E("cg-auto-pieces"),o.appendChild(i),o.appendChild(r),o.appendChild(s)),t.coordinates){let l=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";o.appendChild(Xn(he,"ranks"+l+c)),o.appendChild(Xn(ae,"files"+l))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=E("piece","ghost"),be(a,!1),o.appendChild(a)),{board:n,container:o,wrap:e,ghost:a,svg:i,customSvg:r,autoPieces:s}}function Xn(e,t){let o=E("coords",t),n;for(let i of e)n=E("coord"),n.textContent=i,o.appendChild(n);return o}function Qn(e,t){if(!e.dropmode.active)return;I(e),O(e);let o=e.dropmode.piece;if(o){e.pieces.set("a0",o);let n=W(t),i=n&&H(n,x(e),e.dom.bounds());i&&it(e,"a0",i)}e.dom.redraw()}function Zn(e,t){let o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;let n=Ur(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1})}function ei(e,t){let o=[];if("ResizeObserver"in window||o.push(Le(document.body,"chessground.resize",t)),!e.viewOnly){let n=Jn(e,Dn,Sn),i=Jn(e,In,An);for(let s of["touchmove","mousemove"])o.push(Le(document,s,n));for(let s of["touchend","mouseup"])o.push(Le(document,s,i));let r=()=>e.dom.bounds.clear();o.push(Le(document,"scroll",r,{capture:!0,passive:!0})),o.push(Le(window,"resize",r,{passive:!0}))}return()=>o.forEach(n=>n())}function Le(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}var Ur=e=>t=>{e.draggable.current?re(e):e.drawable.current?io(e):t.shiftKey||We(t)?e.drawable.enabled&&Cn(e,t):e.viewOnly||(e.dropmode.active?Qn(e,t):Ln(e,t))},Jn=(e,t,o)=>n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)};function oi(e){let t=x(e),o=X(e.dom.bounds()),n=e.dom.elements.board,i=e.pieces,r=e.animation.current,s=r?r.plan.anims:new Map,a=r?r.plan.fadings:new Map,l=e.draggable.current,c=Vr(e),u=new Set,p=new Set,y=new Map,v=new Map,g,h,N,_,S,pe,ut,R,pt,Ie;for(h=n.firstChild;h;){if(g=h.cgKey,ii(h))if(N=i.get(g),S=s.get(g),pe=a.get(g),_=h.cgPiece,h.cgDragging&&(!l||l.orig!==g)&&(h.classList.remove("dragging"),A(h,o(m(g),t)),h.cgDragging=!1),!pe&&h.cgFading&&(h.cgFading=!1,h.classList.remove("fading")),N){if(S&&h.cgAnimating&&_===_e(N)){let w=m(g);w[0]+=S[2],w[1]+=S[3],h.classList.add("anim"),A(h,o(w,t))}else h.cgAnimating&&(h.cgAnimating=!1,h.classList.remove("anim"),A(h,o(m(g),t)),e.addPieceZIndex&&(h.style.zIndex=co(m(g),t)));_===_e(N)&&(!pe||!h.cgFading)?u.add(g):pe&&_===_e(pe)?(h.classList.add("fading"),h.cgFading=!0):lo(y,_,h)}else lo(y,_,h);else if(ri(h)){let w=h.className;c.get(g)===w?p.add(g):lo(v,w,h)}h=h.nextSibling}for(let[w,fe]of c)if(!p.has(w)){pt=v.get(fe),Ie=pt&&pt.pop();let q=o(m(w),t);if(Ie)Ie.cgKey=w,A(Ie,q);else{let B=E("square",fe);B.cgKey=w,A(B,q),n.insertBefore(B,n.firstChild)}}for(let[w,fe]of i)if(S=s.get(w),!u.has(w))if(ut=y.get(_e(fe)),R=ut&&ut.pop(),R){R.cgKey=w,R.cgFading&&(R.classList.remove("fading"),R.cgFading=!1);let q=m(w);e.addPieceZIndex&&(R.style.zIndex=co(q,t)),S&&(R.cgAnimating=!0,R.classList.add("anim"),q[0]+=S[2],q[1]+=S[3]),A(R,o(q,t))}else{let q=_e(fe),B=E("piece",q),Oe=m(w);B.cgPiece=q,B.cgKey=w,S&&(B.cgAnimating=!0,Oe[0]+=S[2],Oe[1]+=S[3]),A(B,o(Oe,t)),e.addPieceZIndex&&(B.style.zIndex=co(Oe,t)),n.appendChild(B)}for(let w of y.values())ti(e,w);for(let w of v.values())ti(e,w)}function ni(e){let t=x(e),o=X(e.dom.bounds()),n=e.dom.elements.board.firstChild;for(;n;)(ii(n)&&!n.cgAnimating||ri(n))&&A(n,o(m(n.cgKey),t)),n=n.nextSibling}function uo(e){var t,o;let n=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,r=n.height/n.width,s=Math.floor(n.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*r;i.style.width=s+"px",i.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",a+"px")}var ii=e=>e.tagName==="PIECE",ri=e=>e.tagName==="SQUARE";function ti(e,t){for(let o of t)e.dom.elements.board.removeChild(o)}function co(e,t){let n=e[1];return`${t?3+7-n:3+n}`}var _e=e=>`${e.color} ${e.role}`;function Vr(e){var t,o,n;let i=new Map;if(e.lastMove&&e.highlight.lastMove)for(let a of e.lastMove)j(i,a,"last-move");if(e.check&&e.highlight.check&&j(i,e.check,"check"),e.selected&&(j(i,e.selected,"selected"),e.movable.showDests)){let a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(let c of a)j(i,c,"move-dest"+(e.pieces.has(c)?" oc":""));let l=(n=(o=e.premovable.customDests)===null||o===void 0?void 0:o.get(e.selected))!==null&&n!==void 0?n:e.premovable.dests;if(l)for(let c of l)j(i,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}let r=e.premovable.current;if(r)for(let a of r)j(i,a,"current-premove");else e.predroppable.current&&j(i,e.predroppable.current.key,"current-premove");let s=e.exploding;if(s)for(let a of s.keys)j(i,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,l)=>{j(i,l,a)}),i}function j(e,t,o){let n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function lo(e,t,o){let n=e.get(t);n?n.push(o):e.set(t,[o])}function si(e,t,o){let n=new Map,i=[];for(let a of e)n.set(a.hash,!1);let r=t.firstElementChild,s;for(;r;)s=r.getAttribute("cgHash"),n.has(s)?n.set(s,!0):i.push(r),r=r.nextElementSibling;for(let a of i)t.removeChild(a);for(let a of e)n.get(a.hash)||t.appendChild(o(a))}function ai(e,t){let n=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:jr(i),current:!1}));si(n,t,i=>Fr(e,i,e.dom.bounds()))}function ci(e){var t;let o=x(e),n=X(e.dom.bounds()),i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)vt(i,n(m(i.cgKey),o),i.cgScale),i=i.nextSibling}function Fr(e,{shape:t,hash:o},n){var i,r,s;let a=t.orig,l=(i=t.piece)===null||i===void 0?void 0:i.role,c=(r=t.piece)===null||r===void 0?void 0:r.color,u=(s=t.piece)===null||s===void 0?void 0:s.scale,p=E("piece",`${l} ${c}`);return p.setAttribute("cgHash",o),p.cgKey=a,p.cgScale=u,vt(p,X(n)(m(a),x(e)),u),p}var jr=e=>{var t,o,n;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(o=e.piece)===null||o===void 0?void 0:o.color,(n=e.piece)===null||n===void 0?void 0:n.scale].join(",")};function li(e,t){let o=Bn();at(o,t||{});function n(){let i="dom"in o?o.dom.unbind:void 0,r=Yn(e,o),s=Co(()=>r.board.getBoundingClientRect()),a=u=>{oi(c),r.autoPieces&&ai(c,r.autoPieces),!u&&r.svg&&Vn(c,r.svg,r.customSvg)},l=()=>{uo(c),ni(c),r.autoPieces&&ci(c)},c=o;return c.dom={elements:r,bounds:s,redraw:Xr(a),redrawNow:a,unbind:i},c.drawable.prevSvgHash="",uo(c),a(!1),Zn(c,l),i||(c.dom.unbind=ei(c,l)),c.events.insert&&c.events.insert(r),c}return qn(n(),n)}function Xr(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var di=()=>{let e=window.lichess;e.debug=!1,e.StrongSocket=U,e.mousetrap=new Ce(document),e.requestIdleCallback=oe,e.sri=Z,e.storage=L,e.tempStorage=Ho,e.once=Te,e.powertip=Qe,e.clockWidget=we,e.spinnerHtml=jo,e.assetUrl=z,e.loadCss=Je,e.loadCssPath=ne,e.jsModule=Me,e.loadIife=Nt,e.loadEsm=Q,e.hopscotch=tn,e.userComplete=Ze,e.idleTimer=ke,e.pubsub=b,e.unload=yt,e.redirect=Io,e.reload=ee,e.watchers=Ae,e.escapeHtml=Xe,e.announce=Pe,e.trans=Pt,e.sound=nn,e.mic=dn,e.miniBoard=Ve,e.miniGame=Ge,e.timeago=zo,e.dateFormat=Ct,e.contentLoaded=t=>b.emit("content-loaded",t),e.blindMode=document.body.classList.contains("blind-mode"),e.makeChat=t=>lichess.loadEsm("chat",{init:{el:document.querySelector(".mchat"),...t}}),e.makeChessground=li};console.info("Lichess is open source! https://lichess.org/source");var Yr=d,ui=Yr;var De=class{constructor(t){this.el=t;this.loaded=!1;this.receive=(t,o)=>{this.users.clear(),t.forEach(this.insert),o.playing.map(n=>this.users.get(n)).filter(ye).forEach(n=>n.playing=!0),o.patrons.map(n=>this.users.get(n)).filter(ye).forEach(n=>n.patron=!0),this.repaint()};this.repaint=()=>{this.loaded&&requestAnimationFrame(()=>{var o;let t=Array.from(this.users.keys()).sort();this.titleEl.innerHTML=te.pluralSame("nbFriendsOnline",t.length,this.loaded?`<strong>${t.length}</strong>`:"-"),(o=this.el.querySelector(".nobody"))==null||o.classList.toggle("none",!!t[0]),this.el.querySelector(".list").innerHTML=t.map(n=>this.renderFriend(this.users.get(n))).join("")})};this.renderFriend=t=>{let o=`<i class="line${t.patron?" patron":""}"></i>`,n=t.title?`<span class="utitle"${t.title==="BOT"?" data-bot":""}>${t.title}</span>&nbsp;`:"",i="/@/"+t.name,r=t.playing?`<a data-icon="${He}" class="tv ulpt" data-pt-pos="nw" href="${i}/tv" data-href="${i}"></a>`:"";return`<div><a class="user-link ulpt" data-pt-pos="nw" href="${i}">${o}${n}${t.name}</a>${r}</div>`};this.enters=(t,o)=>{let n=this.insert(t);n.playing=o.playing,n.patron=o.patron,this.repaint()};this.leaves=t=>{this.users.delete(this.getId(t)),this.repaint()};this.playing=t=>{this.insert(t).playing=!0,this.repaint()};this.stopped_playing=t=>{this.insert(t).playing=!1,this.repaint()};this.insert=t=>{let o=this.getId(t);return this.users.has(o)||this.users.set(o,this.toFriend(t)),this.users.get(o)};this.getId=t=>t.toLowerCase().replace(/^\w+\s/,"");this.toFriend=t=>{let o=t.split(" ");return{id:o[o.length-1].toLowerCase(),name:o[o.length-1],title:o.length>1?o[0]:void 0,playing:!1,patron:!1}};this.titleEl=this.el.querySelector(".friend_box_title"),this.titleEl.addEventListener("click",()=>{var o;(o=this.el.querySelector(".content_wrap"))==null||o.classList.toggle("none"),this.loaded||(this.loaded=!0,b.emit("socket.send","following_onlines"))}),this.users=new Map,b.on("socket.in.following_onlines",this.receive),["enters","leaves","playing","stopped_playing"].forEach(o=>b.on("socket.in.following_"+o,this[o]))}};async function pi(){var r;if(!("serviceWorker"in navigator&&"Notification"in window&&"PushManager"in window))return;let e=new URL(z(Me("serviceWorker"),{sameDomain:!0}),self.location.href);e.searchParams.set("asset-url",document.body.getAttribute("data-asset-url")),document.body.getAttribute("data-dev")&&e.searchParams.set("dev","1");let t=document.body.getAttribute("data-dev")?"none":"all",o=await navigator.serviceWorker.register(e.href,{scope:"/",updateViaCache:t}),n=L.make("push-subscribed"),i=document.body.getAttribute("data-vapid");if(i&&Notification.permission=="granted"){let s=await o.pushManager.getSubscription(),a=parseInt(n.get()||"0",10)+432e5<Date.now(),l=Uint8Array.from(atob(i),c=>c.charCodeAt(0));if(!s||a){let c=await o.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:l});try{let u=await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});u.ok&&!u.redirected?n.set(""+Date.now()):c.unsubscribe()}catch(u){console.log("push subscribe failed",u.message),c==null||c.unsubscribe()}}}else n.remove(),(r=await o.pushManager.getSubscription())==null||r.unsubscribe()}function fi(){let e=`<div class="initiating">${lichess.spinnerHtml}</div>`,t=o=>{let n=document.querySelector(o),i=n&&window.getComputedStyle(n).display;return i&&i!="none"};"ontouchstart"in window&&!window.matchMedia("(max-width: 979px)").matches&&$("#topnav > section > a").removeAttr("href"),$("#tn-tg").on("change",o=>document.body.classList.toggle("masked",o.target.checked)),$("#top").on("click",".toggle",function(){let o=$(this).parent().toggleClass("shown");return o.siblings(".shown").removeClass("shown"),setTimeout(()=>{let n=i=>{var r;(r=o[0])!=null&&r.contains(i.target)||(o.removeClass("shown"),$("html").off("click",n))};$("html").on("click",n)},10),!1});{let o,n=$("#challenge-toggle"),i=n.find("span");n.one("mouseover click",()=>r());let r=function(s){if(o)return;let a=$("#challenge-app").html(e);ne("challenge"),o=Q("challenge",{init:{el:a[0],data:s,show(){t("#challenge-app")||n.trigger("click")},setCount(l){let c=i.attr("title").replace(/\d+/,l.toString());i.data("count",l).attr("title",c).attr("aria-label",c)},pulse(){n.addClass("pulse")}}})};b.on("socket.in.challenges",async s=>{o?(await o).update(s):r(s)}),b.on("challenge-app.open",()=>n.trigger("click"))}{let o,n=$("#notify-toggle"),i=n.find("span"),r="#notify-app",s=a=>{if(o)return;let l=$("#notify-app").html(e);ne("notify"),o=Q("notify",{init:{el:l.empty()[0],data:a,isVisible:()=>t(r),updateUnread(c){let u=i.data("count")||0;c=="increment"&&(c=u+1),this.isVisible()&&(c=0);let p=i.attr("title").replace(/\d+/,c.toString());return i.data("count",c).attr("title",p).attr("aria-label",p),c&&c!=u},show(){t(r)||n.trigger("click")},setNotified(){lichess.socket.send("notified")},pulse(){n.addClass("pulse")}}})};n.one("mouseover click",()=>s()).on("click",()=>{"Notification"in window&&Notification.requestPermission(),setTimeout(async()=>{o&&t(r)&&(await o).onShow()},200)}),b.on("socket.in.notifications",async a=>{o?(await o).update(a):s(a)}),b.on("notify-app.set-read",async a=>{o?(await o).setMsgRead(a):s()})}{let o=xe(()=>Q("dasher"));$("#top .dasher .toggle").one("mouseover click",function(){$(this).removeAttr("href"),ne("dasher"),o()})}{let o=$("#clinput");if(!o.length)return;let n=o.find("input"),i=!1,r=()=>{i||(i=!0,Q("cli",{init:{input:n[0]}}).catch(()=>i=!1))};n.on({blur(){n.val(""),$("body").removeClass("clinput")},focus(){r(),$("body").addClass("clinput")}}),o.find("a").on({mouseover:r,click(){$("body").hasClass("clinput")?n[0].blur():n[0].focus()}}),lichess.mousetrap.bind("/",()=>{n.val("/"),n[0].focus()}).bind("s",()=>n[0].focus())}}window.$as=e=>(typeof e=="string"?$(e):e)[0];di();lichess.info=ui;lichess.load.then(()=>{$("#user_tag").removeAttr("href"),requestAnimationFrame(()=>{Ue(),je(),b.on("content-loaded",Ue),b.on("content-loaded",je),St(1e3),b.on("content-loaded",Mt)}),oe(()=>{let e=document.getElementById("friend_box");e&&new De(e);let t=document.querySelector(".chat__members");if(t&&Ae(t),$("#main-wrap").on("click",".autoselect",function(){this.select()}).on("click","button.copy",function(){let n=()=>$(this).attr("data-icon",fo);return $("#"+this.dataset.rel).each(function(){try{navigator.clipboard.writeText(this.value).then(n)}catch(i){console.error(i)}}),!1}),$("body").on("click","a.relation-button",function(){let n=$(this).addClass("processing").css("opacity",.3);return D(this.href,{method:"post"}).then(i=>{i.includes("relation-actions")?n.parent().replaceWith(i):n.replaceWith(i)}),!1}),$(".mselect .button").on("click",function(){let n=$(this).parent();n.toggleClass("shown"),oe(()=>{let i=r=>{n[0].contains(r.target)||(n.removeClass("shown"),$("html").off("click",i))};$("html").on("click",i)},200)}),Qe.watchMouse(),setTimeout(()=>{lichess.socket||(lichess.socket=new U("/socket/v5",!1))},300),fi(),window.addEventListener("resize",()=>document.body.dispatchEvent(new Event("chessground.resize"))),$(".user-autocomplete").each(function(){let n=!!this.autofocus,i=()=>Ze({input:this,friend:!!this.dataset.friend,tag:this.dataset.tag,focus:n});n?i():$(this).one("focus",i)}),$("input.confirm, button.confirm").on("click",function(){return confirm(this.title||"Confirm this action?")}),$("#main-wrap").on("click","a.bookmark",function(){let n=$(this).toggleClass("bookmarked");D(this.href,{method:"post"});let i=(parseInt(n.text(),10)||0)+(n.hasClass("bookmarked")?1:-1);return n.find("span").html(""+(i>0?i:"")),!1}),navigator.userAgent.includes("Edge/")&&setTimeout(()=>{let n=document.getElementById("piece-sprite");n.href=n.href.replace(".css",".external.css")},1e3),Se()&&!("MSStream"in window)){let n=document.querySelector("meta[name=viewport]");n.setAttribute("content",n.getAttribute("content")+",maximum-scale=1.0")}location.hash==="#blind"&&!lichess.blindMode&&D("/toggle-blind-mode",{method:"post",body:Fe({enable:1,redirect:"/"})}).then(ee);let o=document.body.getAttribute("data-announce");o&&Pe(JSON.parse(o)),Vo(),pi(),b.on("socket.in.redirect",n=>{lichess.unload.expected=!0,lichess.redirect(n)}),b.on("socket.in.fen",n=>document.querySelectorAll(".mini-game-"+n.id).forEach(i=>kt(i,n))),b.on("socket.in.finish",n=>document.querySelectorAll(".mini-game-"+n.id).forEach(i=>Tt(i,n.win))),b.on("socket.in.announce",Pe),b.on("socket.in.tournamentReminder",n=>{if($("#announce").length||document.body.dataset.tournamentId==n.id)return;let i="/tournament/"+n.id;$("body").append($('<div id="announce">').append($(`<a data-icon="${bo}" class="text">`).attr("href",i).text(n.name)).append($('<div class="actions">').append($(`<a class="withdraw text" data-icon="${go}">`).attr("href",i+"/withdraw").text(te("pause")).on("click",function(){return D(this.href,{method:"post"}),$("#announce").remove(),!1})).append($(`<a class="text" data-icon="${ho}">`).attr("href",i).text(te("resume")))))})},800)});
